@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="pt-br">


<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta http-equiv="content-language" content="pt-br" />
    <meta name="robots" content="index, follow" />
    <link rel="stylesheet" type="text/css" href="~/CadC/css/reset.css">
    <link rel="stylesheet" type="text/css" href="~/CadC/css/style.css">
    <link rel="stylesheet" type="text/css" href="~/CadC/css/fonts-icones.css">
    <link rel="icon" type="image/x-icon" href="~/iconHarry.png" sizes="32x32" />
    <title>Compra - Ingresso</title>

</head>

<body>

    <header class="main_header container">
        <div class="content">

            <div class="main_header_logo">
                <img src="~/imagens/rick.svg" title="CinEXame" />
            </div>

        </div>
    </header>

    <main class="main_content container">


        <section class="section-seu-codigo container">

            <div class="content">



                <!--Inícia Formulário-->

                <div class="container_form">
                    <div class="box-artigo">
                        <h1 style="text-align:center; color:black">Compre seu Ingresso aqui!!</h1>

                        <form class="form" action="#" method="post">
                            <div id="divCadastro" class="esconder">

                                <div class="col-md-12 mb-3 text-center" style="text-align:center; margin-bottom: 10px">

                                    <img src="" id="imagemFilme" width="350" align="middle" />

                                </div>

                                <div class="col-12 mb-3">
                                    <input id="txtCodigo" type="hidden" />
                                    <label>Filme: </label>
                                    <input id="txtNome" type="text" class="form-control" placeholder="Nome" style="background-color:#A3A3CD; border-radius: 10px; " readonly />
                                    <br />
                                    <br />
                                    <label>Empresa: </label>
                                    <input id="txtEmpresa" type="text" class="form-control" placeholder="Empresa" style="background-color:#A3A3CD; border-radius: 10px; " readonly />
                                    <br />
                                    <br />

                                </div>


                                <div class="col-12 mb-3">
                                    <label>Descrição: </label>
                                    <input id="txtDescricao" type="text" class="form-control" placeholder="Descricao" style="background-color:#A3A3CD; border-radius: 10px; " readonly />
                                    <br />
                                    <br />
                                </div>


                                <div class="col-12 mb-3">
                                    <label>Duração em Minutos: </label>
                                    <input id="txtDuracaoMin" type="text" class="form-control" placeholder="Duracao Minutos" style="background-color:#A3A3CD; border-radius: 10px; " readonly />
                                    <br />
                                    <br />
                                </div>
                                <div class="col-12 mb-3">
                                    <label>Valor Ingresso Unitário R$: </label>
                                    <input id="txtvalor" type="text" class="form-control" placeholder="Valor Ingresso" style="background-color:#A3A3CD; border-radius: 10px; " readonly />
                                    <br />
                                    <br />
                                </div>
                                <div class="col-12 mb-3">
                                    <label>Sala disponível: </label>
                                    <input id="txtSala" type="text" class="form-control" placeholder="Sala" style="background-color:#A3A3CD; border-radius: 10px; " readonly />
                                    <br />
                                    <br />
                                </div>
                                <div class="col-12 mb-3">
                                    <label>Sessões: </label>
                                    <select id="cbSessoes" class="form-control" style="background-color:transparent;border-radius: 10px; " required>

                                        <option>Selecione</option>

                                    </select>
                                    <br />
                                    <br />
                                </div>
                                <div class="col-12 mb-3">
                                    <label>Quantidade: </label>
                                    <input id="txtQtde" type="number" class="form-control" placeholder="Quantidade de Ingressos" style="background-color:transparent; border-radius: 10px; color:black" required />

                                </div>


                                <div class="form_grupo">
                                    <button id="btnSalvar" style="margin-left: 32%" type="button" class="submit_btn">Comprar</button>
                                    <button id="btnVoltar" style="margin-left: 35%" type="button" class="submit_btn"><a asp-controller="Home" asp-action="Index" style="color:white; text-decoration:none;">Voltar</a></button>
                                </div>

                            </div>




                        </form>

                    </div><!--container_form-->
                    <!--Finaliza Formulário-->


                </div><!--Box Artigo-->


                <div class="clear"></div>
            </div>
        </section><!--FECHA BOX HTML-->


    </main>

    <footer class="main_footer container">
        <div class="main_footer_copy">

            <p class="m-b-footer"> CinEXame - 2022, Todos os direitos reservados.</p>
            <p class="by"><i class="icon icon-heart-3"></i> Desenvolvido por: Adrian Silva</p>

        </div>
    </footer>

    <script src="~/CadC/js/jquery.js"></script>
    <script src="~/CadC/js/script.js"></script>


</body>
</html>


<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="@(Url.Content("https://cdn.jsdelivr.net/npm/cleave.js@1.6.0/dist/cleave.min.js"))" type="text/javascript"></script>



<script>
    const urlParams = new URLSearchParams(window.location.search);
    var url = 'https://localhost:44383/api/';
    var urlImagem = 'https://localhost:44383/api/Filme/obterimagem?arquivo=';
    var imagemSelecionada = '';

    function carregarImagem() {
        $('#imagemFilme').val('');
        $('#imagemFilme').attr('src', urlImagem + imagemSelecionada);
    }

    function recuperarFilme(id) {


        $.ajax({
            type: "GET",
            url: url + 'Filme/recuperar?id=' + id,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function(jsonResult) {

                if (jsonResult.status) {

                    console.log(jsonResult);


                    var obj = jsonResult.resultado;


                    imagemSelecionada = obj.imagem;
                    carregarImagem();
                    $('#txtNome').val(obj.nome);
                    $('#txtEmpresa').val(obj.nomeEmpresa);
                    $('#txtDescricao').val(obj.descricao);
                    $('#txtDuracaoMin').val(obj.duracaoMinutos);
                    $('#txtvalor').val(obj.valorIngresso);
                    $('#txtSala').val(obj.nomeSala);

                    $.ajax({
                        type: "GET",
                        url: url + "Sessao/listarPorSala?id=" + obj.idSala,
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function(jsonResult) {

                            if (jsonResult.status) {

                                var lista = jsonResult.resultado;


                                $.each(lista, function(index, value) { //percorre a lista para jogar na table


                                    $('#cbSessoes')
                                        .append($('<option>', {
                                            text: value.horario,
                                            value: value.id

                                        }));

                                });


                            }

                            //console.log(jsonResult);
                        },
                        failure: function(response) {
                            alert("Erro ao carregar os dados: " + response);
                        }
                    });


                }

            },
            failure: function(response) {
                alert("Erro ao carregar os dados: " + response);
            }
        });

    }

    function inserir(id) {

        $.ajax({
            type: "GET",
            url: url + 'Filme/recuperar?id=' + id,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function(jsonResult) {

                if (jsonResult.status) {
                    var idIngresso = '0';
                    var cliente = sessionStorage.getItem('IdCliente');
                    var qtde = $('#txtQtde').val();
                    var sessao = $('#cbSessoes').val();
                    console.log(cliente, qtde, sessao);
                    var obj = jsonResult.resultado;
                    if (idIngresso == '0' && qtde > 0 && sessao != 'Selecione' && cliente != null) {
                        var teste = {
                            Id: idIngresso,
                            IdFilme: parseInt(id),
                            IdCliente: parseInt(cliente),
                            Quantidade: parseInt($('#txtQtde').val()),
                            Sessao: parseInt($('#cbSessoes').val()),
                            ValorTotal: parseFloat($('#txtQtde').val() * obj.valorIngresso),
                            Sala: obj.idSala
                        };

                        $.ajax({
                            type: "PUT",
                            url: url + 'Ingresso/salvar',
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            data: JSON.stringify(teste),
                            success: function(jsonResult) {

                                console.log('metodo post: ', jsonResult);

                                if (jsonResult.status) {
                                    alert("Compra efetuada com sucesso!!");
                                }

                            },
                            failure: function(response) {
                                alert("Erro ao carregar os dados: " + response);
                            }
                        });

                        console.log(teste);
                    } else if (cliente == null) {
                        alert("Para comprar um ingresso é necessário logar com sua conta, volte a tela inicial clique sobre Login!!!");
                    }
                    else if (qtde == '') {
                        alert("A quantidade de ingressos deve ser maor que 0!!");
                    } else if (sessao == 'Selecione') {
                        alert("Favor selecionar uma sessão!!");
                    } else {
                        alert("Falha ao comprar Ingresso!!");
                    };


                }
            },
            failure: function(response) {
                alert("Erro ao carregar os dados: " + response);
            }
        });
    }

    $(function() {
        //chamamos as funções para carregar na pagina

        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get("id");

        recuperarFilme(id);
        $('#btnSalvar').click(function() { inserir(id); });


    });

</script>